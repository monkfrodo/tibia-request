<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Tibia Access Manager</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
  * { margin:0; padding:0; box-sizing:border-box; }

  body {
    font-family: 'Inter', sans-serif;
    background: url("https://www.tibiabr.com/wp-content/uploads/2020/01/paulo-silvente-roshamuul-ld-alternative.jpg")
      no-repeat center center fixed;
    background-size: cover;
    height: 100vh;
    display:flex;
    align-items:center;
    justify-content:center;
    position:relative;
  }

  body::before {
    content:"";
    position:absolute;
    inset:0;
    background:rgba(0,0,0,0.55);
    backdrop-filter:blur(3px);
  }

  .card {
    position:relative;
    width:100%;
    max-width:520px;
    padding:32px 28px 26px;
    border-radius:14px;
    background:rgba(10,10,10,0.8);
    border:1px solid rgba(255,215,0,0.35);
    box-shadow:0 0 28px rgba(0,0,0,0.7);
    color:#fff;
    text-align:center;
  }

  .icon img {
    width:56px;
    height:56px;
    margin-bottom:10px;
    image-rendering:pixelated;
  }

  h1 {
    font-size:26px;
    color:#f8e29c;
    margin-bottom:6px;
  }

  .subtitle {
    font-size:14px;
    color:#ddd;
    margin-bottom:22px;
  }

  label {
    display:block;
    text-align:left;
    font-size:13px;
    margin-bottom:4px;
    color:#e5e7eb;
  }

  input, textarea, button {
    width:100%;
    font-size:14px;
    border-radius:8px;
    border:none;
  }

  input, textarea {
    background:rgba(255,255,255,0.09);
    border:1px solid rgba(148,163,184,0.6);
    padding:10px 12px;
    color:#fff;
    margin-bottom:14px;
  }

  input::placeholder, textarea::placeholder {
    color:#9ca3af;
  }

  textarea {
    resize:vertical;
    min-height:70px;
  }

  button {
    padding:12px;
    margin-top:6px;
    background:#d6b25a;
    font-weight:600;
    cursor:pointer;
    transition:0.2s;
  }

  button:hover {
    background:#c49a3e;
  }

  #charResult {
    display:none;
    margin-top:12px;
    margin-bottom:8px;
    padding:10px 12px;
    background:rgba(15,23,42,0.9);
    border-radius:8px;
    font-size:14px;
    text-align:left;
    border:1px solid rgba(148,163,184,0.5);
  }

  .error {
    color:#f87171;
    font-weight:600;
  }

  #questBlock {
    display:none;
    margin-top:12px;
  }

  #message {
    margin-top:10px;
    font-size:13px;
    text-align:center;
    min-height:18px;
  }

  #autocompleteList {
    margin-top:-8px;
    margin-bottom:10px;
    background:rgba(15,23,42,0.95);
    border-radius:6px;
    border:1px solid rgba(148,163,184,0.7);
    max-height:180px;
    overflow:auto;
    text-align:left;
  }

  #autocompleteList div {
    padding:6px 10px;
    cursor:pointer;
    font-size:13px;
  }

  #autocompleteList div:hover {
    background:rgba(55,65,81,0.9);
  }
</style>
</head>

<body>

<div class="card">
  <div class="icon">
    <img src="https://www.tibiawiki.com.br/images/0/0f/Ferumbras.gif" alt="Ferumbras">
  </div>

  <h1>Tibia Access Manager</h1>
  <div class="subtitle">
    Valide seu personagem e registre pedidos de acesso a quests e bosses.
  </div>

  <!-- Nome do personagem -->
  <label for="charName">Nome do personagem</label>
  <input id="charName" placeholder="Ex: Monk Frodo">

  <button onclick="validateCharacter()">Validar personagem</button>

  <div id="charResult"></div>

  <!-- Bloco de quest (só aparece depois da validação) -->
  <div id="questBlock">
    <label for="requestedAccess">Quest / Boss</label>
    <input id="requestedAccess" placeholder="Digite a quest/boss">
    <div id="autocompleteList"></div>

    <label for="notes">Notas (opcional)</label>
    <textarea id="notes" placeholder="Horários disponíveis, time, world transfer, etc."></textarea>

    <button onclick="sendRequest()">Enviar Pedido</button>
  </div>

  <div id="message"></div>
</div>

<script>
let currentChar = null;
let currentLevel = null;
let currentVocation = null;
let questsLoaded = false;
let quests = [];

/* ---------------------------
   VALIDAR PERSONAGEM (v4)
--------------------------- */
async function validateCharacter() {
  const nameInput = document.getElementById("charName");
  const name = nameInput.value.trim();
  const charResult = document.getElementById("charResult");
  const message = document.getElementById("message");
  const questBlock = document.getElementById("questBlock");

  message.innerHTML = "";
  charResult.style.display = "block";

  if (!name) {
    charResult.innerHTML = "<span class='error'>Digite o nome do personagem.</span>";
    questBlock.style.display = "none";
    return;
  }

  charResult.innerHTML = "Consultando personagem...";

  try {
    const url = `https://api.tibiadata.com/v4/character/${encodeURIComponent(name)}`;
    const r = await fetch(url);
    const json = await r.json();

    if (!json.character || !json.character.character) {
      charResult.innerHTML = "<span class='error'>Personagem não encontrado.</span>";
      questBlock.style.display = "none";
      return;
    }

    const c = json.character.character;

    currentChar = c.name;
    currentLevel = c.level;
    currentVocation = c.vocation;

    charResult.innerHTML = `
      <strong>Nome:</strong> ${c.name}<br>
      <strong>Nível:</strong> ${c.level}<br>
      <strong>Vocação:</strong> ${c.vocation}
    `;

    questBlock.style.display = "block";
    message.innerHTML = "";

    // carrega quests.json só depois de validar o personagem, e só uma vez
    if (!questsLoaded) {
      loadQuests();
    }

  } catch (err) {
    console.error(err);
    charResult.innerHTML = "<span class='error'>Erro ao consultar personagem.</span>";
    questBlock.style.display = "none";
  }
}

/* ---------------------------
   CARREGAR QUESTS.JSON
   (SÓ APÓS VALIDAR)
--------------------------- */
async function loadQuests() {
  questsLoaded = true;
  try {
    const res = await fetch("quests.json");
    quests = await res.json();
  } catch (err) {
    console.error("Erro carregando quests.json:", err);
  }

  const input = document.getElementById("requestedAccess");
  const list = document.getElementById("autocompleteList");

  input.addEventListener("input", () => {
    const val = input.value.toLowerCase();
    list.innerHTML = "";
    if (!val) return;

    const matches = quests
      .filter(q => q.toLowerCase().includes(val))
      .slice(0, 10);

    if (!matches.length) return;

    matches.forEach(q => {
      const div = document.createElement("div");
      div.textContent = q;
      div.onclick = () => {
        input.value = q;
        list.innerHTML = "";
      };
      list.appendChild(div);
    });
  });

  document.addEventListener("click", (e) => {
    if (e.target.id !== "requestedAccess") {
      list.innerHTML = "";
    }
  });
}

/* ---------------------------
   ENVIAR PARA O APPS SCRIPT
--------------------------- */
async function sendRequest() {
  const message = document.getElementById("message");
  const requestedAccess = document.getElementById("requestedAccess").value.trim();
  const notes = document.getElementById("notes").value.trim();

  message.innerHTML = "";

  if (!currentChar) {
    message.innerHTML = "<span class='error'>Valide um personagem antes de enviar.</span>";
    return;
  }

  if (!requestedAccess) {
    message.innerHTML = "<span class='error'>Digite a quest/boss.</span>";
    return;
  }

  const payload = {
    charName: currentChar,
    level: currentLevel,
    vocation: currentVocation,
    requestedAccess: requestedAccess,
    notes: notes
  };

  message.innerHTML = "Enviando para o banco de dados...";

  try {
    const backendUrl = "https://script.google.com/macros/s/AKfycbxXNT-qfqMwpDpI5YidY8ZS1_DFS3Ey2bP39qj4KM-DL2wljYaa6dptBrSs-D5dZhNk/exec";
    const res = await fetch(backendUrl, {
      method: "POST",
      body: JSON.stringify(payload)
    });

    const final = await res.json();

    if (final.success) {
      message.innerHTML = "Pedido registrado com sucesso!";
      document.getElementById("requestedAccess").value = "";
      document.getElementById("notes").value = "";
    } else {
      message.innerHTML = "<span class='error'>Erro ao salvar. Tente novamente.</span>";
    }
  } catch (err) {
    console.error(err);
    message.innerHTML = "<span class='error'>Erro ao enviar para o servidor.</span>";
  }
}
</script>

</body>
</html>
